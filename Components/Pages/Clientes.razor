@page "/clientes"
@rendermode InteractiveServer

<PageTitle>Clientes - ALMA Medical</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-4">Gestión de Clientes</h1>
            <p class="text-muted">Administra tus pacientes y clientes</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary btn-lg" @onclick="MostrarFormularioNuevo">
                <i class="bi bi-plus-circle"></i> Nuevo Cliente
            </button>
        </div>
    </div>

    @if (mostrarFormulario)
    {
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Nuevo Cliente</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" @bind="nuevoCliente.FirstName" placeholder="Nombre" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Apellido</label>
                        <input type="text" class="form-control" @bind="nuevoCliente.LastName" placeholder="Apellido" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" @bind="nuevoCliente.Email" placeholder="email@ejemplo.com" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Teléfono</label>
                        <input type="tel" class="form-control" @bind="nuevoCliente.Phone" placeholder="+54 9 11 1234-5678" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Fecha de Nacimiento</label>
                        <input type="date" class="form-control" @bind="nuevoCliente.DateOfBirth" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">DNI</label>
                        <input type="text" class="form-control" @bind="nuevoCliente.DocumentNumber" placeholder="12345678" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Notas</label>
                        <textarea class="form-control" rows="3" @bind="nuevoCliente.Notes" placeholder="Observaciones, alergias, tratamientos previos..."></textarea>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-success me-2" @onclick="GuardarCliente">
                        <i class="bi bi-check-circle"></i> Guardar
                    </button>
                    <button class="btn btn-secondary" @onclick="CancelarFormulario">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    }

    <div class="card">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="mb-0">Lista de Clientes (@clientes.Count)</h5>
                </div>
                <div class="col-auto">
                    <input type="text" class="form-control" @bind="busqueda" @bind:event="oninput" placeholder="Buscar cliente..." />
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre Completo</th>
                            <th>Email</th>
                            <th>Teléfono</th>
                            <th>DNI</th>
                            <th>Edad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var cliente in ClientesFiltrados)
                        {
                            <tr>
                                <td>
                                    <strong>@cliente.FirstName @cliente.LastName</strong>
                                </td>
                                <td>@cliente.Email</td>
                                <td>@cliente.Phone</td>
                                <td>@cliente.DocumentNumber</td>
                                <td>@CalcularEdad(cliente.DateOfBirth)</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" title="Ver detalles">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning me-1" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@code {
    private List<ClienteDto> clientes = new();
    private ClienteDto nuevoCliente = new();
    private bool mostrarFormulario = false;
    private string busqueda = "";

    protected override void OnInitialized()
    {
        // Datos de ejemplo
        clientes = new List<ClienteDto>
        {
            new ClienteDto { FirstName = "María", LastName = "González", Email = "maria@gmail.com", Phone = "+54 9 11 2345-6789", DocumentNumber = "35123456", DateOfBirth = new DateTime(1990, 5, 15), Notes = "Tratamiento facial mensual" },
            new ClienteDto { FirstName = "Carlos", LastName = "Pérez", Email = "carlos@gmail.com", Phone = "+54 9 11 3456-7890", DocumentNumber = "28987654", DateOfBirth = new DateTime(1985, 8, 22), Notes = "Sesión de depilación láser" },
            new ClienteDto { FirstName = "Ana", LastName = "Martínez", Email = "ana@gmail.com", Phone = "+54 9 11 4567-8901", DocumentNumber = "42567890", DateOfBirth = new DateTime(1995, 3, 10), Notes = "Interesada en tratamientos antiedad" }
        };
    }

    private List<ClienteDto> ClientesFiltrados =>
        string.IsNullOrWhiteSpace(busqueda)
        ? clientes
        : clientes.Where(c =>
            c.FirstName.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ||
            c.LastName.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ||
            (c.Email?.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (c.DocumentNumber?.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ?? false)
        ).ToList();

    private void MostrarFormularioNuevo()
    {
        nuevoCliente = new ClienteDto();
        mostrarFormulario = true;
    }

    private void GuardarCliente()
    {
        if (!string.IsNullOrWhiteSpace(nuevoCliente.FirstName) && !string.IsNullOrWhiteSpace(nuevoCliente.LastName))
        {
            clientes.Add(nuevoCliente);
            mostrarFormulario = false;
            nuevoCliente = new ClienteDto();
        }
    }

    private void CancelarFormulario()
    {
        mostrarFormulario = false;
        nuevoCliente = new ClienteDto();
    }

    private string CalcularEdad(DateTime? fechaNacimiento)
    {
        if (!fechaNacimiento.HasValue) return "-";
        var edad = DateTime.Today.Year - fechaNacimiento.Value.Year;
        if (fechaNacimiento.Value.Date > DateTime.Today.AddYears(-edad)) edad--;
        return $"{edad} años";
    }

    public class ClienteDto
    {
        public string FirstName { get; set; } = "";
        public string LastName { get; set; } = "";
        public string? Email { get; set; }
        public string? Phone { get; set; }
        public string? DocumentNumber { get; set; }
        public DateTime? DateOfBirth { get; set; }
        public string? Notes { get; set; }
    }
}