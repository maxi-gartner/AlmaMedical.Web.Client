@page "/"
@using AlmaMedical.Web.Client.Components.HomeComponents
@using AlmaMedical.Web.Client.Services
@using AlmaMedical.Web.Client.Base
@inject NavigationManager Navigation
@inherits AuthorizedComponentBase

<PageTitle>Home - AlmaMedical</PageTitle>

<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-purple-50 p-4 md:p-6 lg:p-8">
    <!-- Header con selector de rol -->
    <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <p class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                Bienvenido, @GetCurrentUserName()
            </p>
        </div>

        <!-- Selector de Rol (solo para testing) -->
        <div class="rounded-xl bg-white/70 backdrop-blur-sm shadow-lg border border-white/20 p-4">
            <label class="text-sm font-medium text-slate-700 mb-2 block">🧪 Testing - Cambiar Rol:</label>
            <select @onchange="CambiarRol"
                    value="@CurrentUser.UserRole"
                    class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="TenantAdmin">Dueño (Admin)</option>
                <option value="Professional">Profesional</option>
                <option value="Receptionist">Recepcionista</option>
            </select>
            <p class="text-xs text-slate-500 mt-2">Rol actual: <strong>@CurrentUser.UserRole</strong></p>
        </div>
    </div>

    <!-- Main Grid Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column - Main Content (2/3) -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Next Appointment Card (Destacado) -->
            <NextAppointmentCard />

            <!-- Today's Appointments List -->
            <TodayAppointmentsList />

            <!-- Quick Stats (Solo para Professional/Admin) -->
            @if (HasPermission(RolePermissionService.Permission.ViewFinancialMetrics))
            {
                <QuickStats />
            }

            <!-- Weekly Chart (Solo para Professional/Admin) -->
            @if (HasPermission(RolePermissionService.Permission.ViewFinancialMetrics))
            {
                <WeeklyChart />
            }

            <!-- Recent Sales (Solo para Professional/Admin) -->
            @if (HasPermission(RolePermissionService.Permission.ViewSales))
            {
                <RecentSales />
            }
        </div>

        <!-- Right Column - Sidebar (1/3) -->
        <div class="space-y-6">
            <!-- Internal Messaging -->
            <InternalMessaging />

            <!-- Quick Actions -->
            <QuickActions />

            <!-- Tasks & Alerts -->
            <TasksAlerts />
        </div>
    </div>
</div>

@code {
    private string GetCurrentUserName()
    {
        return CurrentUser?.FullName ?? "Usuario";
    }

    private void CambiarRol(ChangeEventArgs e)
    {
        if (e.Value != null)
        {
            CurrentUser.SetRole(e.Value.ToString()!);
            // Forzar recarga completa de la página
            Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
        }
    }
}